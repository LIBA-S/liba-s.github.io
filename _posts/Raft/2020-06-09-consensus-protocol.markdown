---
layout: "post"
title: "consensus protocol"
date: "2021-06-09 14:15"
---

## 1. 分布式系统的设计点？

## 2. 什么是高可用？

所有事物都不是100%可靠的，高可用就是降低系统的风险。

风险：未来发生危害的可用性。
故障：已经发生或正在发生的危害。

风险期望公式：sum(风险概率*故障时间*故障影响面积)

降低风险四个方面：
**1）降低风险个数n**
-减小依赖
**2) 降低风险概率p**
-多设置关卡
**3) 降低故障时间**
-早发现：预警监控
-早止血：切换，回滚，扩容，降级/限流，bug修复。
**4) 降低故障影响面**
-大拆小，单个个体相对独立

高可用系统设计七大原则：

**少依赖**
-（当多依赖可以降低总体风险期望，可以多依赖）。
**弱依赖**
- 必须依赖的，减小依赖程度
**分散原则**
- 打散拆分N，避免鸡蛋放在一个篮子里（故障范围）
**均衡原则**
- N均匀分布，减小故障影响范围
**隔离原则**
- 每份相对独立，减小故障范围。
**无单点原则**
- 单点故障，无法快速止血。
**自我保护**
- 达到容量/qos预警线，限流/降级.

2. 为什么需要共识算法？

为了提高分布式系统可用性，通常采用replicas的方式，实现数据容灾。

3. 高吞吐，高并发，低延时。

## 高并发

### 指标
标准：
1） 系统吞吐量throughput （QPS, TPS）
2） 系统延时latency

目标：一定延时下，最求高的吞吐量。

### 设计方向：

1） 垂直扩展（单机处理能力）
- 硬件：更快的硬件
- 软件：低时延优化

2） 水平扩展（分布式处理）

### 关键技术

**层次划分**
**功能划分**

- 负载均衡 （无状态服务的水平扩展问题）
- 分库分表 （有状态下的水平扩展，分片路由）
- 读写分离
- 读多写少，数据缓存 (CDN)
1) 缓存一致性：
2) 缓存穿透：查询一定不存在的数据，会穿透缓存直接压到数据库，从而导致缓存失去作用 （布隆过滤器）
3) 缓存雪崩：避免同一时间，大量缓存失效（过期时间，引入随机量）
- 写多，消息中间件（kafka）
请求异步化，削峰填谷
- 流控

## 低延时

根本：优化hot-path

如何定位hot-path

优化方向：
**overhead**
- 减小运行时开销（模板元编程，CRTP静态多态，表达式模板）
https://www.modernescpp.com/index.php/expression-templates
**cpu**
- thread local
- cache 友好（空间/时间 局部性），减小false sharding
- 强度消减，减小工作量
**memory**
- 减小运行时，内存开销
